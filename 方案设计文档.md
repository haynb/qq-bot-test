## 方案设计文档

### 一、项目概述

本项目旨在实现一个基于QQ机器人和OpenAI GPT的智能助手服务。该服务通过WebSocket与QQ服务器通信，处理并回应用户消息，并通过OpenAI GPT生成智能回复。项目主要模块包括配置管理模块、机器人管理模块、AI接口模块、和服务主入口模块。

### 二、系统架构

1. **配置管理模块（conf）**
   - 负责加载和管理应用的配置参数，提供全局配置访问接口。
   - 配置文件路径通过命令行参数传递。
2. **机器人管理模块（robot）**
   - 负责与QQ服务器的WebSocket通信。
   - 管理机器人token的获取和定时刷新。
   - 处理和发送消息。
3. **AI接口模块（ai）**
   - 初始化OpenAI GPT客户端。
   - 负责与OpenAI GPT接口通信，发送用户问题并获取AI回复。
   - 管理历史消息记录，确保消息历史不超过限制。
4. **服务主入口模块（main）**
   - 负责解析命令行参数并加载配置文件。
   - 初始化机器人和AI接口。
   - 启动WebSocket连接并处理优雅关闭信号。

### 三、详细设计

#### 1. 配置管理模块（conf）

- 配置文件使用YAML格式，包含AppId、ClientSecret、QQ服务器基础URL、OpenAI服务器基础URL、OpenAI Key、默认模型及最大历史记录条数等。
- 通过LoadFromFile函数加载配置文件，解析并设置全局配置。

#### 2. 机器人管理模块（robot）

- Token管理
  - InitToken函数负责发送请求获取Token并设置定时任务以提前一分钟刷新Token。
- WebSocket管理
  - InitWs函数初始化WebSocket连接。
  - Identify函数发送身份鉴权信息。
  - StartSvc函数启动WebSocket服务，包括接收消息和发送心跳包。
  - CloseWss函数关闭WebSocket连接并停止心跳。

#### 3. AI接口模块（ai）

- OpenAI GPT客户端
  - InitGPT函数初始化GPT客户端，包括设置基础URL、API Key、默认模型和消息历史。
  - AddHistory函数管理历史消息，确保历史记录不超过限制。
  - Ask函数发送用户问题并获取AI回复。

#### 4. 服务主入口模块（main）

- 通过flag包解析命令行参数获取配置文件路径。
- 加载配置文件并初始化机器人和AI接口。
- 启动WebSocket连接，并处理系统中断信号以实现优雅关闭。
- ### 四、待拓展

因为时间问题（最近上班工作确实比较忙，三天时间不太够），还有几点功能可以添加。

- 添加一个向量数据库，存储历史聊天记录，便没有了限制，增加记忆功能。
- 添加知识库功能，具体可参考我的另外一个项目：https://github.com/haynb/go_gpt_assistant 可以接受频道用户上传的文件并解析，作为知识库和预料，来精准回答问题。
- 加入一些情景扮演、角色扮演小游戏，这个实现起来并不困难，存储prompt即可。可让不同的用户建立不同的角色等prompt，存储起来，然后还可以让用户之间分享、传递和使用。
- 添加更多的接口，比如可以添加联网的function call，让模型可以联网回答问题、生成图片等等。
- 接入更多的外部信息，定时启动总结当日新闻、分析世界动态等。
- 添加充值系统（目前已经实现可记录的用户使用量tokens的输出），让用户每天签到获取定量tokens，想更多使用可充值。